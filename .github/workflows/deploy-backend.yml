name: Deploy to EC2 with Docker

on:
  push:
    branches: [ "main" ] # main ë¸Œëœì¹˜ì— í‘¸ì‹œë  ë•Œ ì‹¤í–‰
    paths:
      - 'backend/**' 
      - '.github/workflows/deploy-backend.yml'

jobs:
  # 1. ë¹Œë“œ ë° ë„ì»¤ í—ˆë¸Œ í‘¸ì‹œ ì‘ì—…
  build-and-push:
    runs-on: ubuntu-latest
    steps:
      - name: ì½”ë“œ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v3

      - name: Docker Hub ë¡œê·¸ì¸
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Docker Buildx ì„¤ì •
        uses: docker/setup-buildx-action@v2

      - name: ì´ë¯¸ì§€ ë¹Œë“œ ë° í‘¸ì‹œ
        uses: docker/build-push-action@v4
        with:
          context: ./backend 
          file: ./backend/Dockerfile
          push: true
          # íƒœê·¸: ë³¸ì¸DockerID/ì´ë¯¸ì§€ëª…:latest
          tags: ${{ secrets.DOCKER_USERNAME }}/cops-backend:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max

  # 2. EC2 ë°°í¬ ì‘ì—…
  deploy:
    needs: build-and-push # ë¹Œë“œê°€ ì„±ê³µí•´ì•¼ ì‹¤í–‰ë¨
    runs-on: ubuntu-latest
    steps:
      - name: ì½”ë“œ ì²´í¬ì•„ì›ƒ (docker-compose.yml ê°€ì ¸ì˜¤ê¸° ìœ„í•¨)
        uses: actions/checkout@v3

      # ğŸš€ í•µì‹¬: docker-compose.yml ë‚´ì˜ ë³€ìˆ˜ë¥¼ Secrets ê°’ìœ¼ë¡œ ì¹˜í™˜í•©ë‹ˆë‹¤.
      - name: Replace secrets in docker-compose.yml
        shell: bash
        env:
          DOCKER_USERNAME: ${{ secrets.DOCKER_USERNAME }}
          REDIS_PASSWORD: ${{ secrets.REDIS_PASSWORD }}
        run: |
          # envsubstê°€ íŒŒì¼ ì•ˆì˜ ${VAR}ë¥¼ ì‹¤ì œ í™˜ê²½ë³€ìˆ˜ ê°’ìœ¼ë¡œ ë°”ê¿”ì¤ë‹ˆë‹¤.
          envsubst < docker-compose.yml > docker-compose.prod.yml

      - name: ì™„ì„±ëœ docker-compose.yml íŒŒì¼ EC2ë¡œ ì „ì†¡
        uses: appleboy/scp-action@master
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          source: "docker-compose.prod.yml"
          target: "/home/${{ secrets.EC2_USER }}/backend"

      - name: SSHë¡œ ì„œë²„ ì ‘ì† ë° ë°°í¬ ì‹¤í–‰
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          script: |
            cd /home/${{ secrets.EC2_USER }}/backend
            
            mv docker-compose.prod.yml docker-compose.yml
            
            # 1. .env íŒŒì¼ ìƒì„± (GitHub Secrets ê°’ì„ ì´ìš©í•´ ì„œë²„ì— íŒŒì¼ ìƒì„±)
            echo "DATABASE_URL=${{ secrets.DATABASE_URL }}" > .env
            echo "DIRECT_URL=${{ secrets.DIRECT_URL }}" >> .env
            echo "JWT_SECRET=${{ secrets.JWT_SECRET }}" >> .env
            echo "KAKAO_CLIENT_ID=${{ secrets.KAKAO_CLIENT_ID }}" >> .env
            echo "KAKAO_CALLBACK_URL=${{ secrets.KAKAO_CALLBACK_URL }}" >> .env
            echo "KAKAO_CLIENT_SECRET=${{ secrets.KAKAO_CLIENT_SECRET }}" >> .env
            echo "NODE_ENV=production" >> .env
            echo "PORT=4000" >> .env
            echo "REDIS_HOST=redis" >> .env
            echo "REDIS_PORT=6379" >> .env
            echo "REDIS_PASSWORD=${{ secrets.REDIS_PASSWORD }}" >> .env
          
            docker compose pull backend
            
            # 3. ì»¨í…Œì´ë„ˆ ì¬ì‹¤í–‰
            docker compose up -d --remove-orphans
            
            # 4. ë¶ˆí•„ìš”í•œ ì´ë¯¸ì§€ ì •ë¦¬
            docker image prune -f

            # 5. [ì¶”ê°€] Prisma ë§ˆì´ê·¸ë ˆì´ì…˜ ì‹¤í–‰ (DB ìŠ¤í‚¤ë§ˆ ë™ê¸°í™”) â­
            docker compose exec -T backend npx prisma migrate deploy